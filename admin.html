<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">

    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Admin Dashboard</h2>
            <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">
                Log Out
            </button>
        </div>

        <div id="scriptsList" class="space-y-4">
            <p>Loading scripts...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        const supabaseUrl = 'https://fuhobsopkwzwejamwyqz.supabase.co'; // Ganti dengan URL Supabase-mu
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1aG9ic29wa3d6d2VqYW13eXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODE0OTAsImV4cCI6MjA3Mzc1NzQ5MH0.mO6wt0tzLA5chtBLgaPENEEY7lPe75SQVeE6jOBHH38'; // Ganti dengan anon key Supabase-mu
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const scriptsList = document.getElementById('scriptsList');
        const logoutBtn = document.getElementById('logoutBtn');

        async function checkAuthAndLoadScripts() {
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                // Redirect ke halaman login jika tidak ada pengguna
                window.location.href = '/login';
                return;
            }

            // Dapatkan semua skrip dari database
            const { data: scripts, error } = await supabase
                .from('scripts')
                .select('*');

            if (error) {
                scriptsList.innerHTML = `<p class="text-red-500">Error loading scripts: ${error.message}</p>`;
                return;
            }

            if (scripts.length === 0) {
                scriptsList.innerHTML = `<p class="text-gray-500">No scripts have been uploaded yet.</p>`;
                return;
            }

            // Tampilkan skrip dalam daftar
            scriptsList.innerHTML = scripts.map(script => `
                <div class="p-4 border border-gray-200 rounded-md">
                    <p class="font-semibold text-blue-600 break-all">${window.location.origin}/${script.id}</p>
                    <pre class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">${script.content.substring(0, 100)}...</pre>
                    <button data-id="${script.id}" class="mt-2 text-sm bg-gray-200 text-gray-700 py-1 px-3 rounded hover:bg-gray-300 delete-btn">
                        Delete
                    </button>
                </div>
            `).join('');

            // Tambahkan event listener untuk tombol hapus
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const { error: deleteError } = await supabase.from('scripts').delete().eq('id', id);
                    if (deleteError) {
                        alert('Failed to delete script.');
                    } else {
                        alert('Script deleted successfully.');
                        checkAuthAndLoadScripts(); // Muat ulang daftar skrip
                    }
                });
            });
        }

        logoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('Failed to log out.');
            } else {
                window.location.href = '/login';
            }
        });

        checkAuthAndLoadScripts();
    </script>
</body>
</html>