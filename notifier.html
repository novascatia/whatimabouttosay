<script>
    let supabase;
    let currentRoom = null;
    let currentSubscription = null;
    let allRoomsData = []; 
    let currentActiveIds = { left: null, right: null }; // BARU: Menyimpan ID Kiri/Kanan dari room aktif

    const chatListDiv = document.getElementById('chatList');
    const chatHeader = document.getElementById('chatHeader');
    const messagesContainer = document.getElementById('messagesContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const searchInput = document.getElementById('searchInput'); 

    // ... (formatTime & getLabelFromRoomId tetap sama) ...
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }
    
    function getLabelFromRoomId(roomId) {
        const parts = roomId.split('-');
        if (parts.length === 2) {
             return `User ${parts[0]} with ${parts[1]}`;
        }
        return `Room ID: ${roomId}`;
    }

    // FUNGSI UTAMA BARU: Mengurai ID Kiri/Kanan
    function parseRoomIds(roomId) {
        const parts = roomId.split('-');
        if (parts.length !== 2) return { left: null, right: null };

        // Karena generate_room_id di bot mengurutkan ID, maka:
        // parts[0] = ID yang Lebih Kecil (Left Side default)
        // parts[1] = ID yang Lebih Besar (Right Side default)
        return { 
            left: parts[0], 
            right: parts[1] 
        };
    }
    
    function renderMessage(message, sender, created_at) {
        const messageDiv = document.createElement('div');
        
        // Cek apakah room aktif
        if (!currentActiveIds.left) {
            // Ini seharusnya tidak terjadi jika switchRoom berhasil
            return;
        }

        if (sender === 'system') {
            messageDiv.className = `message-center`;
            messageDiv.innerHTML = message;
        } else {
            // LOGIKA BARU UNTUK MENENTUKAN KANAN/KIRI BERDASARKAN ID
            
            // 1. Tentukan ID pengirim yang sebenarnya
            let sender_id;
            if (sender === 'bot') {
                 // Di kode bot, sender 'bot' adalah ID STAFF/OWNER. 
                 // Kita asumsikan Bot ID (OWNER_ID) adalah salah satu dari dua ID di room.
                 sender_id = currentActiveIds.right; 
            } else {
                 // Jika 'user-A', asumsikan itu ID user yang bukan bot
                 // Kita harus mencari tahu apakah sender adalah ID KECIL atau ID BESAR
                 sender_id = sender; // Biarkan kode bot yang menentukan sender (saat ini bot menggunakan 'user-A' atau 'bot')
            }
            
            // 2. Tentukan sisi
            // Di sini kita ubah logika: jika sender adalah ID Kiri, dia di kiri.
            // Jika sender adalah ID Kanan, dia di kanan.
            // *Karena kita tidak tahu ID mana yang mengirim pesan jika sender='user-A', kita gunakan asumsi yang lebih kuat:
            //   - 'bot' (Admin/Staff) selalu di Kanan (default)
            //   - 'user-A' (User biasa) selalu di Kiri (default)
            //   Ini lebih mudah dan sesuai dengan logika "monitor bot vs user" yang biasa dipakai.
            
            // Coba perbaiki agar 1234 selalu KIRI dan 5678 selalu KANAN
            const isRightSide = (sender === 'bot' || sender === currentActiveIds.right); 
            const isLeftSide = (sender === 'user-A' || sender === currentActiveIds.left);

            // Karena sender bot Anda hanya mengirim 'bot' atau 'user-A', kita harus berpegangan pada label itu.
            // Jika Anda ingin 1234 kiri dan 5678 kanan, Anda harus pastikan di Python:
            // - Pesan dari 1234 di-log dengan sender="id:1234"
            // - Pesan dari 5678 di-log dengan sender="id:5678"
            
            // Karena bot Anda hanya mengirim 'bot' atau 'user-A', kita kembali ke logika:
            // 'bot' (Staff/Admin) = Kanan, 'user-A' (User Biasa) = Kiri.
            
            const useRightSide = sender === 'bot'; // Bot (Staff/Admin) di Kanan
            
            messageDiv.className = `chat-bubble ${useRightSide ? 'message-right' : 'message-left'}`;
            messageDiv.innerHTML = `
                <div class="message-text">${message}</div>
                <span class="message-time">${formatTime(created_at)}</span>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight; 
    }
    
    // FUNGSI BARU: HANYA UPDATE DATA, JANGAN RE-RENDER DOM SIDEBAR SECARA TOTAL
    async function fetchRoomList() {
        try {
            const response = await fetch('/.netlify/functions/fetch-chat-rooms');
            if (!response.ok) throw new Error('Failed to fetch rooms from API.');
            
            const newRoomsData = await response.json();
            
            // Cek apakah ada perubahan struktural (search aktif atau room baru)
            const isSearchActive = searchInput.value.trim().length > 0;
            const hasStructuralChange = newRoomsData.length !== allRoomsData.length || isSearchActive;

            allRoomsData = newRoomsData;

            if (hasStructuralChange) {
                 // Jika ada search atau jumlah room berubah, regenerasi sidebar
                 displayChatList(searchInput.value);
            } else {
                 // Jika struktur sama, cukup update konten/urutan tanpa flashing
                 updateChatListContent();
            }
            
            // Pilih room pertama otomatis jika belum ada yang aktif
            if (!currentRoom && allRoomsData.length > 0) {
                const firstRoom = allRoomsData[0];
                switchRoom(firstRoom.room_id, getLabelFromRoomId(firstRoom.room_id));
            }
            
        } catch (error) {
            // Tampilkan error jika gagal fetch
            if (chatListDiv.innerHTML.includes('Loading')) {
                chatListDiv.innerHTML = `<p class="p-4 text-red-500 text-sm">Error: ${error.message}</p>`;
            }
        }
    }
    
    // BARU: Fungsi untuk update DOM list secara efisien
    function updateChatListContent() {
        const term = searchInput.value.toLowerCase().trim();
        const container = document.getElementById('chatListContainer');
        
        // 1. Buat elemen baru berdasarkan urutan terbaru
        const fragment = document.createDocumentFragment();
        
        const filteredRooms = allRoomsData.filter(room => {
            const label = getLabelFromRoomId(room.room_id).toLowerCase();
            return label.includes(term) || room.room_id.includes(term);
        });

        if (filteredRooms.length === 0) {
            chatListDiv.innerHTML = '<p class="p-4 text-gray-400 text-sm">Tidak ada obrolan yang cocok.</p>';
            return;
        }

        filteredRooms.forEach(room => {
            const room_id = room.room_id;
            const label = getLabelFromRoomId(room_id);
            
            const itemDiv = document.createElement('div');
            itemDiv.className = `chat-item ${room_id === currentRoom ? 'active' : ''}`;
            itemDiv.innerHTML = `
                <div class="font-bold">${label}</div>
                <div class="text-xs text-gray-400">${room.last_message.substring(0, 30)}...</div>
            `;
            itemDiv.setAttribute('data-room-id', room_id);
            itemDiv.setAttribute('data-label', label);
            itemDiv.addEventListener('click', () => switchRoom(room_id, label));
            
            fragment.appendChild(itemDiv);
        });

        // 2. Ganti seluruh konten chatList dengan fragment baru
        chatListDiv.innerHTML = '';
        chatListDiv.appendChild(fragment);
    }


    function displayChatList(searchTerm = '') {
        // Logika displayChatList sekarang memanggil updateChatListContent
        updateChatListContent();
    }
    
    async function switchRoom(newRoomId, newLabel) {
        if (newRoomId === currentRoom) return;

        // 1. Bersihkan langganan lama
        if (currentSubscription) {
            supabase.removeChannel(currentSubscription);
            currentSubscription = null;
        }
        
        // BARU: Set ID Kiri/Kanan
        currentActiveIds = parseRoomIds(newRoomId); 

        // 2. Perbarui state UI
        currentRoom = newRoomId;
        chatHeader.textContent = newLabel;
        messagesContainer.innerHTML = ''; 
        loadingMessage.classList.remove('hidden');
        loadingMessage.textContent = `Loading history for ${newLabel}...`;
        
        // Tandai item di sidebar
        displayChatList(searchInput.value);

        // 3. Ambil 50 pesan terakhir (riwayat)
        const { data: initialMessages, error: fetchError } = await supabase
            .from('chat_messages')
            .select('*')
            .eq('room_id', currentRoom)
            .order('created_at', { ascending: true })
            .limit(50);

        if (fetchError) {
            loadingMessage.textContent = `Error loading history: ${fetchError.message}`;
            return;
        }
        
        loadingMessage.classList.add('hidden');
        initialMessages.forEach(msg => renderMessage(msg.message, msg.sender, msg.created_at));

        // 4. Berlangganan (Subscribe) ke Realtime
        currentSubscription = supabase
            .channel(`room:${currentRoom}`) 
            .on(
                'postgres_changes',
                { 
                    event: 'INSERT', schema: 'public', table: 'chat_messages', 
                    filter: `room_id=eq.${currentRoom}`
                },
                (payload) => {
                    const newMsg = payload.new;
                    renderMessage(newMsg.message, newMsg.sender, newMsg.created_at);
                    // Panggil fetchRoomList untuk memperbarui urutan/last_message (tanpa flashing)
                    fetchRoomList(); 
                }
            )
            .subscribe();
    }
    
    async function initSupabase() {
        chatListDiv.innerHTML = '<p class="p-4 text-gray-400 text-sm">Initializing...</p>';
        
        const response = await fetch('/.netlify/functions/get-config');
        if (!response.ok) {
            chatListDiv.innerHTML = '<p class="p-4 text-red-500 text-sm">Error: Could not get Supabase keys.</p>';
            return;
        }
        const keys = await response.json();
        
        supabase = window.supabase.createClient(keys.supabaseUrl, keys.supabaseKey);
        // Atur interval polling untuk daftar room (untuk refresh list jika ada pesan baru)
        fetchRoomList();
        setInterval(fetchRoomList, 5000); // Poll setiap 5 detik untuk memastikan daftar room up-to-date
    }
    
    // Event Listener untuk Pencarian
    searchInput.addEventListener('input', () => {
        displayChatList(searchInput.value);
    });

    initSupabase();
</script>